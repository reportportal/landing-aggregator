name: Build RC Docker image

on:
  workflow_dispatch:
    inputs:
      BUILD_PLATFORMS:
        description: 'Platforms to build'
        required: true
        default: 'linux/amd64,linux/arm64'
      AWS_REGION:
        description: 'AWS region'
        required: true
        default: 'us-east-1'
      VERSION:
        description: 'Version'
        required: true
        default: 'latest'
jobs:
  golangci:
    name: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: false
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: 'v1.56'
          args:
            --timeout=10m
            --disable=errcheck
            --disable=gas
  call-docker-build:
    name: Call release candidate Docker build
    needs: golangci
    uses: reportportal/.github/.github/workflows/build-docker-image.yaml@main
    with:
      aws-region: ${{ vars.AWS_REGION }}
      image-tag: ${{ vars.VERSION }}-${{ github.run_number }}
      additional-tag: 'latest'
      build-platforms: ${{ vars.BUILD_PLATFORMS }}
      version: ${{ vars.VERSION }}
      scan-image: true
    secrets: inherit
